<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" /> 
    <title>Twittler</title>
    <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/style.css" type="text/css">

    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
  </head>
  <body>
    <header>
      <p>Twittler v.0.0.1</p>
    </header>

    <nav style="display:none;">
      <p><a href="#" id="reset">reset</a></p>
    </nav>

    <div id="stream">
    </div>

    <script>
      $(document).ready(function(){

        var filterMode = "_all"; // Choose whether we're filtering by a specific username or showing all tweets.

        // Initially load the Twitter stream
        var index = streams.home.length - 1;

        // Keep track of where our old initial index was so that we can display new tweets that are pushed to the array and stop when we get to tweets that have already been displayed.
        var oldindex = index;

        // Get tweets from our array.
        var getTweets = function (userTweets, index) {
          if (filterMode == "_all") {
            var tweet = streams.home[index];           
          } else {
            var tweet = streams.users[filterMode][index];
          }

          var $tweet = $('<div class="tweet" data-username="' + tweet.user +'"></div>');
          //$tweet.text('@' + tweet.user + ': ' + tweet.message);
          $tweet.html('<span class="username"><a href="#">@' + tweet.user + '</a></span><br/><span class="tweet-text">' + tweet.message + '</span><br><span class="tweet-time">' + tweet.created_at + '</span><br><br>');
          $tweet.prependTo($("#stream"));          
        }

        while(index >= 0){
          getTweets(null, index);
          index -= 1;
        }

        // Call this function with an interval to get new tweets that have been pushed to the stream.
        var updateStream = function() {
          if (filterMode == "_all") {
            index = streams.home.length - 1;
          } else {
            index = streams.users[filterMode].length - 1;
          }
          
          var newIndex = index + 1;
          while (index >= oldindex) {
            getTweets(null, index);
            index -= 1;
          };
          oldindex = newIndex;
        };

        // Update the stream at a set interval and append new tweets to the page.
        setInterval(function() {
          updateStream();

        }, 5500);
      
        // Filter the stream to only show tweets from a specific username.
        $('#stream').on('click', 'a', function() {
          // Store the username that we want to filter.
          var filtername = $(this).closest('.tweet').data('username');

          // Clear out stream so we can only display tweets from specific user.
          $('#stream').html('');

          // Show our nav
          $('nav').show();

          // Display all tweets from user.
          // TODO: Refactor our initial getTweet function to utilize this code as well.
          var userTweets = streams.users[filtername];
          var countTweets = userTweets.length - 1;

          console.log(userTweets);
          console.log(countTweets);

          //while(countTweets >= 0){
          for (var i = 0; i <= countTweets; i++) {
            filterMode = filtername;
            getTweets(userTweets, i);
          }          

        });

        // Reset button to show all tweets again.
        $('nav').on('click', '#reset', function () {
          filterMode = "_all";
          index = streams.home.length - 1;
          oldindex = index;
          console.log(index);
          while(index >= 0){
            getTweets(null, index);
            index -= 1;
          }
          $('nav').hide();
        });

        // Highlight tweet when we mouse over it.
        $('#stream').on('mouseenter', '.tweet', function() {
          $(this).toggleClass('highlight');
        })

        // Un-highlight tweet when we move mouse away
        $('#stream').on('mouseleave', '.tweet', function() {
          $(this).toggleClass('highlight');
        })        

      });

    </script>
  </body>
</html>
